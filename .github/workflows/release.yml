name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ChangeLog
        uses: GoogleCloudPlatform/release-please-action@v3
        id: release
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          release-type: node
          package-name: pro
          labels: autorelease
          pull-request-header: ':robot: I have created a release ğŸ·'
          changelog-types: '[{"type": "feat", "section": "âœ¨æ–°åŠŸèƒ½", "hidden": false},{"type": "fix", "section": "ğŸ›é—®é¢˜ä¿®å¤", "hidden": false},{"type": "perf", "section":"ğŸ’¡æ€§èƒ½ä¼˜åŒ–", "hidden": false},{"type": "refactor", "section":"âœ¨ä»£ç é‡æ„", "hidden": false},{"type": "docs", "section":"ğŸ“„æ–‡æ¡£", "hidden": false},{"type": "style", "section":"ğŸ§µä»£ç æ ¼å¼", "hidden": false},{"type": "test", "section":"ğŸ“‹æµ‹è¯•", "hidden": false},{"type": "build", "section":"ğŸ“¦é¡¹ç›®æ„å»º/ä¾èµ–", "hidden": false},{"type": "revert", "section":"ğŸ©¹ç‰ˆæœ¬å›æ»š", "hidden": false},{"type": "ci", "section":"ğŸª›CIæŒç»­é›†æˆ", "hidden":false},{"type": "workflow", "section":"ğŸ”–å·¥ä½œæµ", "hidden": false},{"type": "chore", "section": "ğŸ–‡ï¸å…¶ä»–", "hidden": false}]'
      
      - name: Checkout
        uses: actions/checkout@v3 # git å…‹éš†åˆ°å½“å‰æœºå™¨ä¸Š
        if: ${{ steps.release.outputs.release_created }}
        
      - name: Node
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          registry-url: https://registry.npmjs.org/
          cache: 'yarn'
          
      - name: Cache
        if: ${{ steps.release.outputs.release_created }}
        id: cache-dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
          key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
          
      - name: Yarn
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: yarn

      - name: Build
        if: ${{ steps.release.outputs.release_created }}
        run: yarn build
        
      - name: Publish
        if: ${{ steps.release.outputs.release_created }}
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}